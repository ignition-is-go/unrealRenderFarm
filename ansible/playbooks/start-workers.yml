---
# Start render workers on all nodes
# Usage: ansible-playbook -i inventory.yml playbooks/start-workers.yml
#
# Uses scheduled task because WinRM kills child processes when session ends
# See: https://docs.ansible.com/ansible/latest/os_guide/windows_usage.html

- name: Start Render Workers
  hosts: render_nodes
  gather_facts: false

  vars:
    repo_path: C:\Users\Administrator\unrealRenderFarm
    uv_path: C:\Users\Administrator\.local\bin\uv.exe

  tasks:
    - name: Create scheduled task for render worker
      community.windows.win_scheduled_task:
        name: RenderFarmWorker
        description: Unreal Render Farm Worker Process
        actions:
          - path: "{{ uv_path }}"
            arguments: run python requestWorker.py
            working_directory: "{{ repo_path }}"
        triggers:
          - type: registration  # runs immediately when task is created
          - type: logon         # runs when user logs in (including auto-logon)
            delay: PT10S        # 10 second delay after logon
        username: Administrator
        password: "{{ ansible_password }}"
        logon_type: interactive_token  # runs in interactive session with GPU access
        run_level: highest
        state: present
        enabled: true

    - name: Stop existing task and processes
      ansible.windows.win_shell: |
        Stop-ScheduledTask -TaskName RenderFarmWorker -ErrorAction SilentlyContinue
        Get-Process -Name python -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
      changed_when: true

    - name: Start the scheduled task
      ansible.windows.win_shell: |
        Start-ScheduledTask -TaskName RenderFarmWorker
      changed_when: true

    - name: Wait for worker to start
      ansible.builtin.pause:
        seconds: 3

    - name: Verify worker is running
      ansible.windows.win_shell: |
        Get-Process -Name python -ErrorAction SilentlyContinue |
        Where-Object { $_.CommandLine -like '*requestWorker*' }
      register: worker_check
      changed_when: false
      failed_when: false

    - name: Report worker status
      ansible.builtin.debug:
        msg: "{{ 'Worker running' if worker_check.stdout | trim != '' else 'Worker NOT running - check task scheduler' }}"
